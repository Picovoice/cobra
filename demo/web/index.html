<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="node_modules/@picovoice/cobra-web-worker/dist/iife/index.js"></script>
    <script src="node_modules/@picovoice/web-voice-processor/dist/iife/index.js"></script>
    <script type="application/javascript">
      function writeMessage(message) {
        console.log(message);
        let p = document.createElement("p");
        let text = document.createTextNode(message);
        p.appendChild(text);
        document.body.appendChild(p);
      }

      function writeVoiceProbability(message, value) {
        document.getElementById("voiceProbabilityText").innerHTML = message;
        document.getElementById("voiceProbabilityRange").value = value * 100;
      }

      function cobraCallback(voiceProbability) {
        const timestamp = new Date();
        writeVoiceProbability(
          `Voice detected with probability of ${voiceProbability.toFixed(2)} at ${timestamp.toString()}`,
          voiceProbability
        );
      }

      async function startCobra(appId) {
        writeMessage("Cobra is loading. Please wait...");
        let engineHandle = null;
        try {
          engineHandle = await CobraWebWorker.CobraWorkerFactory.create(
            appId,
            cobraCallback
          );
        } catch (error) {
          writeMessage(error);
          throw new Error(error);
        }
        writeMessage("Cobra worker ready!");

        writeMessage(
          "WebVoiceProcessor initializing. Microphone permissions requested ..."
        );

        try {
          let webVp = await window.WebVoiceProcessor.WebVoiceProcessor.init({
            engines: [engineHandle],
          });
          writeMessage("WebVoiceProcessor ready and listening!");
        } catch (e) {
          writeMessage("WebVoiceProcessor failed to initialize: " + e);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        startCobra();
      });
    </script>
  </head>

  <body>
    <h1>Cobra Web Demo - worker</h1>
    <p>
      This demo uses Cobra for Web and the WebVoiceProcessor packages to create
      an instance of Cobra that listens for voice activity and outputs them to
      the page. After entering the AppID, click the "run Cobra" button.
    </p>

    <label for="appId"
      >AppID string provided by
      <a href="https://picovoice.ai/console/">Picovoice Console</a>:</label
    >
    <input type="text" id="appId" name="appId" />
    <input
      type="button"
      id="sumbit"
      value="Run Cobra"
      onclick="startCobra(document.getElementById('appId').value)"
    />
    <hr />

    <div id="voiceProbability" class="voiceProbability">
      <h2 id="voiceProbabilityText">
        Waiting for the Cobra engine to be initialized ...
      </h2>
      <input
        type="range"
        min="0"
        max="100"
        value="0"
        class="slider"
        disabled="true"
        id="voiceProbabilityRange"
      />
    </div>
  </body>
</html>
